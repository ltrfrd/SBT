{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Run #{{ run.id }} - {{ route.name }}</h1>
  <div class="d-flex gap-2">
    <button class="btn btn-success btn-sm" id="startBtn">Start Run</button>
    <button class="btn btn-danger btn-sm" id="finishBtn">Finish Run</button>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div id="map"></div>
  </div>
  <div class="col-lg-4">
    <div class="card mb-3">
      <div class="card-body">
        <div><strong>Status:</strong> <span id="runStatus">{{ run.status }}</span></div>
        <div><strong>Current Stop:</strong> <span id="currentStop">-</span></div>
        <div><strong>Next Stop:</strong> <span id="nextStop">-</span></div>
        <div><strong>Progress:</strong> <span id="progress">0%</span></div>
        <div><strong>ETA:</strong> <span id="eta">-</span></div>
        <div><strong>Alert:</strong> <span id="alert" class="text-danger">-</span></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">Stops</div>
      <ul class="list-group list-group-flush">
        {% for stop in stops %}
          <li class="list-group-item">{{ stop.sequence }}. {{ stop.name }}</li>
        {% else %}
          <li class="list-group-item text-muted">No stops configured</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const runId = {{ run.id }};
  const initialStatus = "{{ run.status }}";
  const stops = [
    {% for stop in stops %}
      {name: "{{ stop.name }}", lat: {{ stop.latitude }}, lon: {{ stop.longitude }}},
    {% endfor %}
  ];

  const mapCenter = stops.length ? [stops[0].lat, stops[0].lon] : [37.0902, -95.7129];
  const map = L.map('map').setView(mapCenter, stops.length ? 13 : 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  stops.forEach((s, i) => L.marker([s.lat, s.lon]).addTo(map).bindPopup(`${i + 1}. ${s.name}`));
  let busMarker = L.marker(mapCenter).addTo(map).bindPopup('Bus');

  const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${protocol}://${location.host}/ws/gps/${runId}`);
  let watcher = null;

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.error) {
      document.getElementById('alert').textContent = data.error;
      return;
    }

    document.getElementById('currentStop').textContent = data.current_stop || '-';
    document.getElementById('nextStop').textContent = data.next_stop || '-';
    document.getElementById('progress').textContent = `${data.progress_percent}%`;
    document.getElementById('eta').textContent = `${data.eta_minutes} min`;
    document.getElementById('alert').textContent = data.alert || '-';

    busMarker.setLatLng([data.latitude, data.longitude]);
    map.panTo([data.latitude, data.longitude]);
  };

  function startGpsStream() {
    if (!navigator.geolocation || watcher !== null) return;
    watcher = navigator.geolocation.watchPosition((position) => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          speed_kmh: position.coords.speed ? position.coords.speed * 3.6 : null
        }));
      }
    }, (err) => {
      document.getElementById('alert').textContent = `GPS error: ${err.message}`;
    }, { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 });
  }

  async function post(path) {
    const res = await fetch(path, { method: 'POST' });
    const data = await res.json();
    document.getElementById('runStatus').textContent = data.status;
    if (data.status === 'active') startGpsStream();
    if (data.status === 'completed' && watcher !== null) navigator.geolocation.clearWatch(watcher);
  }

  document.getElementById('startBtn').addEventListener('click', () => post(`/runs/${runId}/start`));
  document.getElementById('finishBtn').addEventListener('click', () => post(`/runs/${runId}/finish`));

  if (initialStatus === 'active') startGpsStream();
</script>
{% endblock %}
